# 进料需求与實際請購數量同步功能

## 功能概述

本功能实现了耗材管控表中进料需求（W01-W04周需求）与耗材计算表中實際請購數量之间的双向数据同步，确保两个表格的数据保持一致。

## 🎯 功能特性

### ✨ 双向同步
- **进料需求 → 實際請購數量**: 将各周的进料需求汇总到實際請購數量
- **實際請購數量 → 进料需求**: 将實際請購數量安排在W02（第二周）

### 🔄 智能分配
- **多站别支持**: 自动处理多站别项目的复杂数据分配
- **业务逻辑分配**: 根據實際採購流程，将實際請購數量安排在W02（第二周）
- **数据一致性**: 确保同步后数据的总和保持一致

### 🤖 自动实时同步
- **智能检测**: 自动检测進料需求或實際請購數量的变化
- **实时同步**: 在编辑保存时自动触发相应的同步操作
- **静默处理**: 同步过程不干扰用户操作，提供流畅体验

## 📊 数据映射关系

### 进料需求字段
```typescript
chase_data: {
  "2025-07": {
    "W01": number,  // 第1周需求
    "W02": number,  // 第2周需求  
    "W03": number,  // 第3周需求
    "W04": number   // 第4周需求
  }
}
```

### 實際請購數量字段
```typescript
actual_order: number  // 实际订购数量
```

## 🛠️ 技术实现

### 后端API
```python
@action(detail=False, methods=['post'])
def sync_chase_data_with_actual_order(self, request):
    """同步进料需求与實際請購數量"""
    # 支持两个方向的数据同步
    # direction: 'chase_to_order' | 'order_to_chase'
```

### 前端功能
```typescript
// 同步函数
const handleSyncChaseDataWithActualOrder = async (
  direction: 'chase_to_order' | 'order_to_chase'
) => {
  // 调用API进行数据同步
  // 自动刷新页面数据
  // 显示同步结果
};
```

## 🎮 使用方法

### 1. 自动实时同步（推荐）
- **编辑项目时自动同步**: 当您在编辑模态框中修改進料需求或實際請購數量时，系统会自动同步到另一个字段
- **智能检测变化**: 系统会检测数据变化并自动触发相应的同步操作
- **静默处理**: 同步过程在后台进行，不会干扰您的操作

### 2. 手动批量同步
- 进入申请表详情页面
- 切换到"管控表"标签页
- 使用同步按钮：
  - **进料需求→實際請購**: 点击"进料需求→實際請購"按钮
  - **實際請購→进料需求**: 点击"實際請購→进料需求"按钮，系统会提示选择目标周（W01/W02/W03/W04）

### 3. 同步结果
- 系统自动刷新数据
- 表格数据实时更新
- 保持数据一致性

## 📋 同步规则

### 业务背景
- **采购周期**: 通常从采购到到货需要1-2周时间
- **最佳采购时间**: W02（第二周）安排采购，W03（第三周）耗材到货
- **库存管理**: 避免W01和W04安排采购，防止库存积压

### 进料需求 → 實際請購數量
1. **单站别项目**: 直接汇总各周需求
   ```
   actual_order = W01 + W02 + W03 + W04
   ```

2. **多站别项目**: 平均分配总需求
   ```
   total_chase = sum(all_weeks)
   per_station = total_chase / station_count
   actual_order = total_chase
   ```

### 實際請購數量 → 进料需求
1. **灵活周选择**: 用户可以选择将實際請購數量安排在哪一周
   ```
   // 用户选择目标周（W01/W02/W03/W04）
   target_week = user_selection  // 默认W02
   
   // 根据选择安排
   W01 = target_week == 'W01' ? actual_order : 0
   W02 = target_week == 'W02' ? actual_order : 0
   W03 = target_week == 'W03' ? actual_order : 0
   W04 = target_week == 'W04' ? actual_order : 0
   ```

2. **周选择建议**: 
   - **W01（第一周）**: 提前采购，确保早期供应
   - **W02（第二周）**: 推荐选择，平衡采购和到货时间
   - **W03（第三周）**: 紧急采购，快速到货
   - **W04（第四周）**: 月末采购，为下月准备

## 🔍 数据验证

### 同步前检查
- 验证申请表ID和目标月份
- 检查数据完整性
- 确认权限验证

### 同步后验证
- 数据总和一致性检查
- 多站别数据完整性验证
- 自动刷新页面数据

## 🎨 用户界面

### 按钮位置
- 位于管控表标题右侧
- 两个按钮并排显示
- 使用不同颜色区分功能

### 视觉反馈
- 同步过程中显示加载状态
- 成功/失败消息提示
- 数据实时更新显示

## 📈 应用场景

### 1. 需求规划
- 从周需求汇总到月采购计划
- 确保采购数量与需求一致

### 2. 采购执行
- 从月采购计划分配到周进料（主要安排在W02）
- 优化库存和采购节奏，确保第三周耗材到货

### 3. 数据一致性
- 消除管控表和计算表的数据差异
- 提高数据管理效率

## 🔧 配置选项

### 同步方向
- `chase_to_order`: 进料需求 → 實際請購數量
- `order_to_chase`: 實際請購數量 → 进料需求

### 目标月份
- 自动获取当前申请表的目标月份
- 支持自定义月份同步

### 目标周选择
- **W01**: 第一周采购
- **W02**: 第二周采购（推荐）
- **W03**: 第三周采购
- **W04**: 第四周采购
- 用户可根据实际业务需求灵活选择

## 🚀 未来扩展

### 计划功能
- 支持更多时间维度（月度、季度）
- 增加数据冲突检测和解决
- 提供同步历史记录
- 支持批量同步操作

### 优化方向
- 提高同步性能
- 增加数据验证规则
- 支持自定义分配算法
- 提供同步预览功能

## 📝 注意事项

1. **数据备份**: 同步前建议备份重要数据
2. **权限控制**: 确保用户有相应操作权限
3. **数据完整性**: 同步后检查数据准确性
4. **业务逻辑**: 理解业务规则后再进行同步

---

*本功能为耗材管理系统提供了强大的数据同步能力，确保管控表和计算表的数据一致性，提高管理效率。* 