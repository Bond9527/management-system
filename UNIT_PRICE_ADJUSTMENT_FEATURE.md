# 耗材单价调整功能

## 功能概述

本次更新为耗材管理系统添加了单价调整功能，用户现在可以在库存调整时同时修改耗材的单价。

## 新增功能

### ✨ 单价调整
- **调整模态框增强**: 在库存调整模态框中添加了单价调整字段
- **当前单价显示**: 显示耗材的当前单价作为参考
- **新单价输入**: 允许用户输入新的单价（可选）
- **数据验证**: 对输入的单价进行有效性验证
- **实时更新**: 调整完成后立即更新界面显示

### 🎯 使用场景
- **价格调整**: 当耗材市场价格发生变化时
- **成本控制**: 根据采购成本调整单价
- **财务核算**: 确保库存价值计算的准确性

## 技术实现

### 1. 前端更新

#### 类型定义更新
```typescript
export interface AdjustStockRequest {
  supply_id: number;
  type: "in" | "out" | "adjust";
  quantity: number;
  unit_price?: number; // 新增：可选的单价调整
  remark?: string;
}
```

#### 调整模态框增强
- 添加单价调整输入字段
- 显示当前单价作为参考
- 支持小数点输入（step="0.01"）
- 添加数据验证

#### 状态管理优化
- 在调整完成后根据是否修改单价决定数据更新策略
- 如果修改了单价，重新获取耗材数据确保同步
- 如果只调整库存，直接更新本地状态

### 2. 后端更新

#### API增强
- `adjust_stock` API 新增 `unit_price` 参数
- 添加单价验证逻辑
- 在事务中同时更新库存和单价
- 保持数据一致性

#### 数据验证
- 单价不能为负数
- 单价必须是有效数字
- 可选的单价调整（不输入则不修改）

## 使用方法

### 1. 进入耗材详情页面
- 在库存总览页面点击耗材名称
- 或直接访问 `/supplies/details/:id`

### 2. 点击调整按钮
- 在页面右上角点击"调整"按钮
- 系统会打开调整模态框

### 3. 输入调整信息
- **数量**: 输入调整后的库存数量（必填）
- **单价**: 输入新的单价（可选，留空则不修改）
- **备注**: 输入调整原因或说明

### 4. 确认调整
- 点击"确认"按钮提交调整
- 系统会验证输入数据的有效性
- 调整成功后会自动更新界面显示

## 界面展示

### 调整模态框
```
┌─────────────────────────────────────┐
│ 库存调整 - 探针连接器                │
├─────────────────────────────────────┤
│ 当前库存: 25 个 [库存充足]          │
│                                     │
│ 调整后库存 *                        │
│ [25] 个                             │
│                                     │
│ 单价调整（可选）                     │
│ 当前单价：¥28.00                    │
│ [¥30.00] 输入新单价（留空则不修改）  │
│                                     │
│ 备注说明                            │
│ [价格调整]                          │
│                                     │
│ [取消] [确认]                       │
└─────────────────────────────────────┘
```

## 数据一致性

### 事务处理
- 使用数据库事务确保库存和单价同时更新
- 如果任一操作失败，整个调整操作会回滚
- 保证数据的一致性和完整性

### 前端同步
- 调整完成后立即更新界面显示
- 重新计算库存总价值
- 确保用户看到的是最新数据

## 注意事项

1. **单价调整是可选的**: 如果不需要调整单价，可以留空单价字段
2. **数据验证**: 系统会验证输入的单价值是否有效
3. **权限控制**: 需要登录用户才能进行调整操作
4. **操作记录**: 所有调整操作都会记录在变动记录中
5. **影响范围**: 单价调整会影响库存总价值的计算

## 兼容性

- 向后兼容：现有的库存调整功能不受影响
- API兼容：新增的 `unit_price` 参数是可选的
- 数据兼容：现有数据无需迁移

## 未来扩展

- 支持批量单价调整
- 添加单价调整历史记录
- 支持不同货币的单价
- 添加价格趋势分析功能 