import React, { useState, useEffect } from "react";
import {
  Button,
  Card,
  CardBody,
  CardHeader,
  Modal,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  Input,
  Select,
  SelectItem,
  Tabs,
  Tab,
  Chip,
  Checkbox,
  CheckboxGroup,
  Textarea,
  Spinner,
} from "@heroui/react";
import { addToast } from "@heroui/toast"; // å–æ¶ˆæ³¨é‡Š
import {
  PlusIcon,
  PencilIcon,
  TrashIcon,
  CalculatorIcon,
  EyeIcon,
} from "@heroicons/react/24/outline";

import {
  ApplicationTemplate,
  ApplicationForm,
  applicationTemplateService,
  applicationFormService,
} from "../services/materialManagement";
import { api } from "../services/api";
import { useAuth } from "../context/AuthContext";

import DynamicApplicationDetail from "@/components/DynamicApplicationDetail";

const DynamicApplicationManager: React.FC = () => {
  const { user } = useAuth();
  // çŠ¶æ€ç®¡ç†
  const [templates, setTemplates] = useState<ApplicationTemplate[]>([]);
  const [forms, setForms] = useState<ApplicationForm[]>([]);
  const [loading, setLoading] = useState(false);
  const [templateModalVisible, setTemplateModalVisible] = useState(false);
  const [formModalVisible, setFormModalVisible] = useState(false);
  const [currentTemplate, setCurrentTemplate] =
    useState<ApplicationTemplate | null>(null);
  const [currentForm, setCurrentForm] = useState<ApplicationForm | null>(null);
  const [activeTab, setActiveTab] = useState("templates");

  // è¯¦ç»†é¡µé¢çŠ¶æ€
  const [showDetailPage, setShowDetailPage] = useState(false);
  const [selectedForm, setSelectedForm] = useState<ApplicationForm | null>(
    null,
  );

  // è¡¨å•æ•°æ®
  const [templateFormData, setTemplateFormData] = useState<
    Partial<ApplicationTemplate>
  >({
    is_active: true,
    has_calculation: false,
    template_type: [],
  });
  const [applicationFormData, setApplicationFormData] = useState<
    Partial<ApplicationForm>
  >({
    status: "draft",
  });

  // æ¨¡ç‰ˆå¤åˆ¶ç›¸å…³çŠ¶æ€
  const [enableCopyFromTemplate, setEnableCopyFromTemplate] = useState(false);
  const [sourceFormId, setSourceFormId] = useState<number | null>(null);

  // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
  useEffect(() => {
    loadTemplates();
    loadForms();
  }, []);

  // åŠ è½½æ¨¡æ¿æ•°æ®
  const loadTemplates = async () => {
    setLoading(true);
    try {
      console.log("å¼€å§‹åŠ è½½æ¨¡æ¿æ•°æ®...");
      const data = await applicationTemplateService.getAll();

      console.log("APIè¿”å›çš„æ¨¡æ¿æ•°æ®:", data);
      // Ensure data is always an array
      setTemplates(Array.isArray(data) ? data : []);
      console.log(
        "è®¾ç½®æ¨¡æ¿çŠ¶æ€å®Œæˆï¼Œæ•°æ®æ•°é‡:",
        Array.isArray(data) ? data.length : 0,
      );
    } catch (error) {
      console.error("åŠ è½½æ¨¡æ¿å¤±è´¥:", error);
      console.error("Toast: åŠ è½½æ¨¡æ¿å¤±è´¥: " + (error as Error).message);
      // Set templates to empty array on error
      setTemplates([]);
    } finally {
      setLoading(false);
    }
  };

  // åŠ è½½ç”³è¯·è¡¨æ•°æ®
  const loadForms = async () => {
    setLoading(true);
    try {
      const data = await applicationFormService.getAll();

      // Ensure data is always an array
      setForms(Array.isArray(data) ? data : []);
    } catch (error) {
      console.error("Toast: åŠ è½½ç”³è¯·è¡¨å¤±è´¥");
      // Set forms to empty array on error
      setForms([]);
    } finally {
      setLoading(false);
    }
  };

  // æ¨¡æ¿ç›¸å…³æ“ä½œ
  const handleCreateTemplate = () => {
    setCurrentTemplate(null);
    setTemplateFormData({
      is_active: true,
      has_calculation: false,
      template_type: [],
    });
    setTemplateModalVisible(true);
  };

  const handleEditTemplate = (template: ApplicationTemplate) => {
    setCurrentTemplate(template);
    setTemplateFormData(template);
    setTemplateModalVisible(true);
  };

  const handleDeleteTemplate = async (id: number) => {
    try {
      await applicationTemplateService.delete(id);
      console.log("Toast: åˆ é™¤æ¨¡æ¿æˆåŠŸ");
      alert("âœ… åˆ é™¤æ¨¡æ¿æˆåŠŸ");
      loadTemplates();
    } catch (error) {
      console.error("åˆ é™¤æ¨¡æ¿å¤±è´¥:", error);

      let errorMessage = "åˆ é™¤æ¨¡æ¿å¤±è´¥";

      if (error instanceof Error) {
        errorMessage += `ï¼š${error.message}`;
      } else if (typeof error === "object" && error !== null) {
        // å°è¯•ä»APIå“åº”ä¸­æå–é”™è¯¯ä¿¡æ¯
        const errorObj = error as any;

        if (errorObj.detail) {
          errorMessage += `ï¼š${errorObj.detail}`;
        } else if (errorObj.message) {
          errorMessage += `ï¼š${errorObj.message}`;
        } else if (errorObj.error) {
          errorMessage += `ï¼š${errorObj.error}`;
        }
      }

      // å¸¸è§é”™è¯¯æç¤º
      if (errorMessage.includes("404")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤";
      } else if (errorMessage.includes("403")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæ²¡æœ‰æƒé™åˆ é™¤æ­¤æ¨¡æ¿";
      } else if (errorMessage.includes("400")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæ¨¡æ¿æ­£åœ¨è¢«ä½¿ç”¨ï¼Œè¯·å…ˆåˆ é™¤ç›¸å…³çš„ç”³è¯·è¡¨";
      } else if (errorMessage.includes("500")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
      }

      alert(
        `âŒ ${errorMessage}\n\nå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æ¨¡æ¿æ˜¯å¦è¢«ç”³è¯·è¡¨å¼•ç”¨ï¼ˆéœ€è¦å…ˆåˆ é™¤ç›¸å…³ç”³è¯·è¡¨ï¼‰\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æ˜¯å¦æœ‰æ“ä½œæƒé™`,
      );
      console.error("Toast: åˆ é™¤æ¨¡æ¿å¤±è´¥");
    }
  };

  const handleTemplateSubmit = async () => {
    try {
      if (currentTemplate) {
        await applicationTemplateService.update(
          currentTemplate.id,
          templateFormData,
        );
        console.log("Toast: æ›´æ–°æ¨¡æ¿æˆåŠŸ");
      } else {
        await applicationTemplateService.create(templateFormData);
        console.log("Toast: åˆ›å»ºæ¨¡æ¿æˆåŠŸ");
      }
      setTemplateModalVisible(false);
      loadTemplates();
    } catch (error) {
      console.error(
        "Toast: " + (currentTemplate ? "æ›´æ–°æ¨¡æ¿å¤±è´¥" : "åˆ›å»ºæ¨¡æ¿å¤±è´¥"),
      );
    }
  };

  // ç”³è¯·è¡¨ç›¸å…³æ“ä½œ
  const handleCreateForm = () => {
    setCurrentForm(null);
    setApplicationFormData({ status: "draft" });
    setEnableCopyFromTemplate(false);
    setSourceFormId(null);
    setFormModalVisible(true);
  };

  const handleEditForm = (form: ApplicationForm) => {
    setCurrentForm(form);
    setApplicationFormData(form);
    setFormModalVisible(true);
  };

  const handleDeleteForm = async (id: number) => {
    try {
      await applicationFormService.delete(id);
      console.log("Toast: åˆ é™¤ç”³è¯·è¡¨æˆåŠŸ");
      alert("âœ… åˆ é™¤ç”³è¯·è¡¨æˆåŠŸ");
      loadForms();
    } catch (error) {
      console.error("åˆ é™¤ç”³è¯·è¡¨å¤±è´¥:", error);

      let errorMessage = "åˆ é™¤ç”³è¯·è¡¨å¤±è´¥";

      if (error instanceof Error) {
        errorMessage += `ï¼š${error.message}`;
      } else if (typeof error === "object" && error !== null) {
        // å°è¯•ä»APIå“åº”ä¸­æå–é”™è¯¯ä¿¡æ¯
        const errorObj = error as any;

        if (errorObj.detail) {
          errorMessage += `ï¼š${errorObj.detail}`;
        } else if (errorObj.message) {
          errorMessage += `ï¼š${errorObj.message}`;
        } else if (errorObj.error) {
          errorMessage += `ï¼š${errorObj.error}`;
        }
      }

      // å¸¸è§é”™è¯¯æç¤º
      if (errorMessage.includes("404")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šç”³è¯·è¡¨ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤";
      } else if (errorMessage.includes("403")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæ²¡æœ‰æƒé™åˆ é™¤æ­¤ç”³è¯·è¡¨";
      } else if (errorMessage.includes("400")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šç”³è¯·è¡¨åŒ…å«å…³è”æ•°æ®ï¼Œè¯·å…ˆåˆ é™¤ç›¸å…³çš„è®¡ç®—é¡¹ç›®";
      } else if (errorMessage.includes("500")) {
        errorMessage = "åˆ é™¤å¤±è´¥ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
      }

      alert(
        `âŒ ${errorMessage}\n\nå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. ç”³è¯·è¡¨æ˜¯å¦åŒ…å«è®¡ç®—é¡¹ç›®ï¼ˆéœ€è¦å…ˆåˆ é™¤ï¼‰\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æ˜¯å¦æœ‰æ“ä½œæƒé™`,
      );
      console.error("Toast: åˆ é™¤ç”³è¯·è¡¨å¤±è´¥");
    }
  };

  const handleFormSubmit = async () => {
    try {
      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!applicationFormData.template) {
        throw new Error("è¯·é€‰æ‹©ç”³è¯·è¡¨æ¨¡æ¿");
      }
      if (!applicationFormData.name) {
        throw new Error("è¯·è¾“å…¥ç”³è¯·è¡¨åç§°");
      }
      if (!applicationFormData.code) {
        throw new Error("è¯·è¾“å…¥ç”³è¯·è¡¨ä»£ç ");
      }
      if (!applicationFormData.department) {
        throw new Error("è¯·è¾“å…¥ç”³è¯·éƒ¨é—¨");
      }
      if (!applicationFormData.period) {
        throw new Error("è¯·è¾“å…¥ç”³è¯·å‘¨æœŸ");
      }
      if (!applicationFormData.status) {
        applicationFormData.status = "draft"; // é»˜è®¤è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
      }
      if (!user?.id) {
        throw new Error("ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");
      }

      // å‡†å¤‡æäº¤æ•°æ®
      const formData = {
        template: applicationFormData.template,
        name: applicationFormData.name,
        code: applicationFormData.code,
        department: applicationFormData.department,
        period: applicationFormData.period,
        status: applicationFormData.status,
        has_calculation_form: false, // åˆå§‹çŠ¶æ€æ²¡æœ‰è®¡ç®—è¡¨
        created_by: user.id, // ä»è®¤è¯ä¸Šä¸‹æ–‡ä¸­è·å–ç”¨æˆ·ID
      };

      let newFormId: number;

      if (currentForm) {
        const updatedForm = await applicationFormService.update(
          currentForm.id,
          formData,
        );

        console.log("æ›´æ–°ç”³è¯·è¡¨æˆåŠŸ:", updatedForm);
        addToast({
          title: "æˆåŠŸ",
          description: "æ›´æ–°ç”³è¯·è¡¨æˆåŠŸ",
          color: "success",
          timeout: 3000,
          shouldShowTimeoutProgress: true,
        });
        newFormId = currentForm.id;
      } else {
        const newForm = await applicationFormService.create(formData);

        console.log("åˆ›å»ºç”³è¯·è¡¨æˆåŠŸ:", newForm);
        addToast({
          title: "æˆåŠŸ",
          description: "åˆ›å»ºç”³è¯·è¡¨æˆåŠŸ",
          color: "success",
          timeout: 3000,
          shouldShowTimeoutProgress: true,
        });
        newFormId = newForm.id;

        // å¦‚æœå¯ç”¨äº†æ¨¡ç‰ˆå¤åˆ¶åŠŸèƒ½ä¸”é€‰æ‹©äº†æºç”³è¯·è¡¨ï¼Œåˆ™å¤åˆ¶è€—ææ•°æ®
        if (enableCopyFromTemplate && sourceFormId) {
          try {
            await copyMaterialsFromTemplate(newFormId, sourceFormId);
            addToast({
              title: "æˆåŠŸ",
              description: "å·²è‡ªåŠ¨å¤åˆ¶è€—æä¿¡æ¯",
              color: "success",
              timeout: 3000,
              shouldShowTimeoutProgress: true,
            });
          } catch (error) {
            console.error("å¤åˆ¶è€—æä¿¡æ¯å¤±è´¥:", error);
            addToast({
              title: "è­¦å‘Š",
              description: "ç”³è¯·è¡¨åˆ›å»ºæˆåŠŸï¼Œä½†å¤åˆ¶è€—æä¿¡æ¯å¤±è´¥",
              color: "warning",
              timeout: 4000,
              shouldShowTimeoutProgress: true,
            });
          }
        }
      }

      setFormModalVisible(false);
      setEnableCopyFromTemplate(false);
      setSourceFormId(null);
      loadForms();
    } catch (error) {
      console.error("æäº¤ç”³è¯·è¡¨å¤±è´¥:", error);
      addToast({
        title: "é”™è¯¯",
        description:
          error instanceof Error
            ? error.message
            : "æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®",
        color: "danger",
        timeout: 5000,
        shouldShowTimeoutProgress: true,
      });
    }
  };

  // å¤åˆ¶è€—æä¿¡æ¯åŠŸèƒ½
  const copyMaterialsFromTemplate = async (
    targetFormId: number,
    sourceFormId: number,
  ) => {
    try {
      const result = await api.post(
        "/dynamic-calculation-items/copy_from_template/",
        {
          target_form_id: targetFormId,
          source_form_id: sourceFormId,
        },
      );

      console.log("å¤åˆ¶ç»“æœ:", result);

      return result;
    } catch (error) {
      console.error("å¤åˆ¶è€—æä¿¡æ¯å¤±è´¥:", error);
      throw error;
    }
  };

  // åˆ›å»ºè®¡ç®—è¡¨
  const handleCreateCalculationForm = async (formId: number) => {
    try {
      await applicationFormService.createCalculationForm(formId);
      console.log("Toast: åˆ›å»ºè®¡ç®—è¡¨æˆåŠŸ");
      loadForms();
    } catch (error) {
      console.error("Toast: åˆ›å»ºè®¡ç®—è¡¨å¤±è´¥");
    }
  };

  // æŸ¥çœ‹è¯¦ç»†æ•°æ®
  const handleViewForm = (form: ApplicationForm) => {
    console.log("Viewing form:", form);
    setSelectedForm(form);
    setShowDetailPage(true);
  };

  // è¿”å›åˆ—è¡¨é¡µé¢
  const handleBackToList = () => {
    setShowDetailPage(false);
    setSelectedForm(null);
    // é‡æ–°åŠ è½½æ•°æ®ä»¥è·å–æœ€æ–°çŠ¶æ€
    loadForms();
  };

  // æ¨¡æ¿ç±»å‹æ˜ å°„
  const getTemplateTypeLabel = (type: string | string[]) => {
    const typeMap = {
      supply_management: "è€—æç®¡æ§ç”³è¯·è¡¨",
      demand_calculation: "éœ€æ±‚è®¡ç®—è¡¨",
      capacity_forecast: "äº§èƒ½é¢„æµ‹è¡¨",
      custom: "è‡ªå®šä¹‰è¡¨æ ¼",
    };

    if (Array.isArray(type)) {
      return type
        .map((t) => typeMap[t as keyof typeof typeMap] || t)
        .join(", ");
    }

    return typeMap[type as keyof typeof typeMap] || type;
  };

  // å¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¦ç»†é¡µé¢ï¼Œæ˜¾ç¤ºè¯¦ç»†ç»„ä»¶
  if (showDetailPage && selectedForm) {
    return (
      <DynamicApplicationDetail
        allowReturn={true}
        applicationForm={selectedForm}
        onBack={handleBackToList}
      />
    );
  }

  return (
    <div>
      <Card className="w-full">
        <CardHeader>
          <h1 className="text-xl font-semibold">åŠ¨æ€ç”³è¯·è¡¨ç®¡ç†ç³»ç»Ÿ</h1>
        </CardHeader>
        <CardBody>
          <Tabs
            selectedKey={activeTab}
            onSelectionChange={(key) => setActiveTab(key as string)}
          >
            <Tab key="templates" title="ç”³è¯·è¡¨æ¨¡æ¿">
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Button
                    color="primary"
                    startContent={<PlusIcon className="w-4 h-4" />}
                    onPress={handleCreateTemplate}
                  >
                    æ–°å»ºæ¨¡æ¿
                  </Button>
                </div>

                {loading ? (
                  <div className="flex justify-center py-8">
                    <Spinner />
                  </div>
                ) : (
                  <div className="space-y-4">
                    {templates.map((template) => (
                      <Card key={template.id} className="border">
                        <CardBody>
                          <div className="flex justify-between items-start">
                            <div className="space-y-2">
                              <div className="flex items-center gap-2">
                                <h3 className="font-semibold">
                                  {template.name}
                                </h3>
                                <Chip size="sm" variant="flat">
                                  {template.code}
                                </Chip>
                              </div>
                              <p className="text-sm text-gray-600">
                                {getTemplateTypeLabel(template.template_type)}
                              </p>
                              <div className="flex gap-2">
                                <Chip
                                  color={
                                    template.is_active ? "success" : "danger"
                                  }
                                  size="sm"
                                  variant="flat"
                                >
                                  {template.is_active ? "å¯ç”¨" : "åœç”¨"}
                                </Chip>
                                <Chip
                                  color={
                                    template.has_calculation
                                      ? "primary"
                                      : "default"
                                  }
                                  size="sm"
                                  variant="flat"
                                >
                                  {template.has_calculation
                                    ? "åŒ…å«è®¡ç®—"
                                    : "ä»…ç®¡æ§"}
                                </Chip>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <Button
                                size="sm"
                                startContent={
                                  <PencilIcon className="w-4 h-4" />
                                }
                                variant="ghost"
                                onPress={() => handleEditTemplate(template)}
                              >
                                ç¼–è¾‘
                              </Button>
                              <Button
                                color="danger"
                                size="sm"
                                startContent={<TrashIcon className="w-4 h-4" />}
                                variant="ghost"
                                onPress={() => {
                                  if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ")) {
                                    handleDeleteTemplate(template.id);
                                  }
                                }}
                              >
                                åˆ é™¤
                              </Button>
                            </div>
                          </div>
                        </CardBody>
                      </Card>
                    ))}
                  </div>
                )}
              </div>
            </Tab>

            <Tab key="forms" title="ç”³è¯·è¡¨å®ä¾‹">
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Button
                    color="primary"
                    startContent={<PlusIcon className="w-4 h-4" />}
                    onPress={handleCreateForm}
                  >
                    æ–°å»ºç”³è¯·è¡¨
                  </Button>
                  <p className="text-sm text-gray-500">
                    ğŸ’¡
                    æç¤ºï¼šåˆ›å»ºæ–°ç”³è¯·è¡¨æ—¶å¯ä»¥ä»å·²æœ‰ç”³è¯·è¡¨å¤åˆ¶è€—æä¿¡æ¯ï¼Œå¤§å¤§æé«˜å½•å…¥æ•ˆç‡
                  </p>
                </div>

                {loading ? (
                  <div className="flex justify-center py-8">
                    <Spinner />
                  </div>
                ) : (
                  <div className="space-y-4">
                    {forms.map((form) => (
                      <Card key={form.id} className="border">
                        <CardBody>
                          <div className="flex justify-between items-start">
                            <div className="space-y-2">
                              <div className="flex items-center gap-2">
                                <h3 className="font-semibold">{form.name}</h3>
                                <Chip size="sm" variant="flat">
                                  {form.code}
                                </Chip>
                              </div>
                              <div className="flex gap-4 text-sm text-gray-600">
                                <span>éƒ¨é—¨: {form.department}</span>
                                <span>å‘¨æœŸ: {form.period}</span>
                              </div>
                              <div className="flex gap-2">
                                <Chip
                                  color={
                                    form.status === "active"
                                      ? "success"
                                      : form.status === "draft"
                                        ? "warning"
                                        : "default"
                                  }
                                  size="sm"
                                  variant="flat"
                                >
                                  {form.status === "draft"
                                    ? "è‰ç¨¿"
                                    : form.status === "active"
                                      ? "å¯ç”¨"
                                      : "å½’æ¡£"}
                                </Chip>
                                {form.has_calculation_form && (
                                  <Chip
                                    color="primary"
                                    size="sm"
                                    variant="flat"
                                  >
                                    åŒ…å«è®¡ç®—è¡¨
                                  </Chip>
                                )}
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <Button
                                color="primary"
                                size="sm"
                                startContent={<EyeIcon className="w-4 h-4" />}
                                variant="ghost"
                                onPress={() => handleViewForm(form)}
                              >
                                æŸ¥çœ‹è¯¦ç»†
                              </Button>
                              {!form.has_calculation_form && (
                                <Button
                                  size="sm"
                                  startContent={
                                    <CalculatorIcon className="w-4 h-4" />
                                  }
                                  variant="ghost"
                                  onPress={() =>
                                    handleCreateCalculationForm(form.id)
                                  }
                                >
                                  åˆ›å»ºè®¡ç®—è¡¨
                                </Button>
                              )}
                              <Button
                                size="sm"
                                startContent={
                                  <PencilIcon className="w-4 h-4" />
                                }
                                variant="ghost"
                                onPress={() => handleEditForm(form)}
                              >
                                ç¼–è¾‘
                              </Button>
                              <Button
                                color="danger"
                                size="sm"
                                startContent={<TrashIcon className="w-4 h-4" />}
                                variant="ghost"
                                onPress={() => {
                                  if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”³è¯·è¡¨å—ï¼Ÿ")) {
                                    handleDeleteForm(form.id);
                                  }
                                }}
                              >
                                åˆ é™¤
                              </Button>
                            </div>
                          </div>
                        </CardBody>
                      </Card>
                    ))}
                  </div>
                )}
              </div>
            </Tab>
          </Tabs>
        </CardBody>
      </Card>

      {/* æ¨¡æ¿åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        className="mx-4"
        isOpen={templateModalVisible}
        placement="center"
        scrollBehavior="inside"
        size="2xl"
        onOpenChange={setTemplateModalVisible}
      >
        <ModalContent className="max-h-[90vh]">
          <ModalHeader>{currentTemplate ? "ç¼–è¾‘æ¨¡æ¿" : "æ–°å»ºæ¨¡æ¿"}</ModalHeader>
          <ModalBody className="max-h-[60vh] overflow-y-auto">
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input
                  isRequired
                  label="æ¨¡æ¿åç§°"
                  placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°"
                  value={templateFormData.name || ""}
                  onChange={(e) =>
                    setTemplateFormData({
                      ...templateFormData,
                      name: e.target.value,
                    })
                  }
                />

                <Input
                  isRequired
                  label="æ¨¡æ¿ä»£ç "
                  placeholder="è¯·è¾“å…¥æ¨¡æ¿ä»£ç ï¼ˆå¦‚ï¼šTEMPLATE_001ï¼‰"
                  value={templateFormData.code || ""}
                  onChange={(e) =>
                    setTemplateFormData({
                      ...templateFormData,
                      code: e.target.value,
                    })
                  }
                />
              </div>

              <CheckboxGroup
                isRequired
                description="é€‰æ‹©æ­¤æ¨¡æ¿æ”¯æŒçš„åŠŸèƒ½ç±»å‹"
                label="æ¨¡æ¿ç±»å‹ (å¯å¤šé€‰)"
                value={
                  Array.isArray(templateFormData.template_type)
                    ? templateFormData.template_type
                    : templateFormData.template_type
                      ? [templateFormData.template_type]
                      : []
                }
                onValueChange={(values) => {
                  setTemplateFormData({
                    ...templateFormData,
                    template_type: values.length > 1 ? values : values[0] || [],
                  });
                }}
              >
                <Checkbox value="supply_management">è€—æç®¡æ§ç”³è¯·è¡¨</Checkbox>
                <Checkbox value="demand_calculation">éœ€æ±‚è®¡ç®—è¡¨</Checkbox>
                <Checkbox value="capacity_forecast">äº§èƒ½é¢„æµ‹è¡¨</Checkbox>
                <Checkbox value="custom">è‡ªå®šä¹‰è¡¨æ ¼</Checkbox>
              </CheckboxGroup>

              <Textarea
                className="resize-none"
                label="æ¨¡æ¿æè¿°"
                maxRows={5}
                minRows={3}
                placeholder="è¯·è¾“å…¥æ¨¡æ¿æè¿°"
                value={templateFormData.description || ""}
                onChange={(e) =>
                  setTemplateFormData({
                    ...templateFormData,
                    description: e.target.value,
                  })
                }
              />

              <div className="flex flex-wrap gap-4">
                <Checkbox
                  isSelected={templateFormData.has_calculation}
                  onValueChange={(checked) =>
                    setTemplateFormData({
                      ...templateFormData,
                      has_calculation: checked,
                    })
                  }
                >
                  åŒ…å«è®¡ç®—åŠŸèƒ½
                </Checkbox>
                <Checkbox
                  isSelected={templateFormData.is_active}
                  onValueChange={(checked) =>
                    setTemplateFormData({
                      ...templateFormData,
                      is_active: checked,
                    })
                  }
                >
                  å¯ç”¨æ¨¡æ¿
                </Checkbox>
              </div>
            </div>
          </ModalBody>
          <ModalFooter>
            <Button
              color="danger"
              variant="light"
              onPress={() => setTemplateModalVisible(false)}
            >
              å–æ¶ˆ
            </Button>
            <Button color="primary" onPress={handleTemplateSubmit}>
              {currentTemplate ? "æ›´æ–°" : "åˆ›å»º"}
            </Button>
          </ModalFooter>
        </ModalContent>
      </Modal>

      {/* ç”³è¯·è¡¨åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        className="mx-4"
        isOpen={formModalVisible}
        placement="center"
        scrollBehavior="inside"
        size="2xl"
        onOpenChange={setFormModalVisible}
      >
        <ModalContent className="max-h-[90vh]">
          <ModalHeader>{currentForm ? "ç¼–è¾‘ç”³è¯·è¡¨" : "æ–°å»ºç”³è¯·è¡¨"}</ModalHeader>
          <ModalBody className="max-h-[60vh] overflow-y-auto">
            <div className="space-y-4">
              <Select
                isRequired
                label="é€‰æ‹©æ¨¡æ¿"
                placeholder="è¯·é€‰æ‹©ç”³è¯·è¡¨æ¨¡æ¿"
                selectedKeys={
                  applicationFormData.template
                    ? [applicationFormData.template.toString()]
                    : []
                }
                onSelectionChange={(keys) => {
                  const key = Array.from(keys)[0] as string;

                  setApplicationFormData({
                    ...applicationFormData,
                    template: parseInt(key),
                  });
                }}
              >
                {templates
                  .filter((t) => t.is_active)
                  .map((template) => (
                    <SelectItem
                      key={template.id.toString()}
                      textValue={`${template.name} (${template.code})`}
                    >
                      {template.name} ({template.code})
                    </SelectItem>
                  ))}
              </Select>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input
                  isRequired
                  label="ç”³è¯·è¡¨åç§°"
                  placeholder="è¯·è¾“å…¥ç”³è¯·è¡¨åç§°"
                  value={applicationFormData.name || ""}
                  onChange={(e) =>
                    setApplicationFormData({
                      ...applicationFormData,
                      name: e.target.value,
                    })
                  }
                />

                <Input
                  isRequired
                  label="ç”³è¯·è¡¨ä»£ç "
                  placeholder="è¯·è¾“å…¥ç”³è¯·è¡¨ä»£ç ï¼ˆå¦‚ï¼šFORM_001ï¼‰"
                  value={applicationFormData.code || ""}
                  onChange={(e) =>
                    setApplicationFormData({
                      ...applicationFormData,
                      code: e.target.value,
                    })
                  }
                />
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input
                  isRequired
                  label="ç”³è¯·éƒ¨é—¨"
                  placeholder="è¯·è¾“å…¥ç”³è¯·éƒ¨é—¨"
                  value={applicationFormData.department || ""}
                  onChange={(e) =>
                    setApplicationFormData({
                      ...applicationFormData,
                      department: e.target.value,
                    })
                  }
                />

                <Input
                  isRequired
                  label="ç”³è¯·å‘¨æœŸ"
                  placeholder="è¯·è¾“å…¥ç”³è¯·å‘¨æœŸï¼ˆå¦‚ï¼š2025å¹´7æœˆï¼‰"
                  value={applicationFormData.period || ""}
                  onChange={(e) =>
                    setApplicationFormData({
                      ...applicationFormData,
                      period: e.target.value,
                    })
                  }
                />
              </div>

              <Select
                isRequired
                label="çŠ¶æ€"
                placeholder="è¯·é€‰æ‹©çŠ¶æ€"
                selectedKeys={
                  applicationFormData.status ? [applicationFormData.status] : []
                }
                onSelectionChange={(keys) => {
                  const key = Array.from(keys)[0] as string;

                  setApplicationFormData({
                    ...applicationFormData,
                    status: key as any,
                  });
                }}
              >
                <SelectItem key="draft" textValue="è‰ç¨¿">
                  è‰ç¨¿
                </SelectItem>
                <SelectItem key="active" textValue="å¯ç”¨">
                  å¯ç”¨
                </SelectItem>
                <SelectItem key="archived" textValue="å½’æ¡£">
                  å½’æ¡£
                </SelectItem>
              </Select>

              {/* æ¨¡ç‰ˆå¤åˆ¶åŠŸèƒ½ */}
              {!currentForm && (
                <div className="space-y-4">
                  <div className="border-t pt-4">
                    <h4 className="text-md font-semibold mb-3 text-blue-600">
                      ğŸš€ æ™ºèƒ½å¤åˆ¶åŠŸèƒ½
                    </h4>
                    <div className="space-y-2">
                      <Checkbox
                        isSelected={enableCopyFromTemplate}
                        onValueChange={setEnableCopyFromTemplate}
                      >
                        ä»å·²æœ‰ç”³è¯·è¡¨å¤åˆ¶è€—æä¿¡æ¯
                      </Checkbox>
                      <p className="text-sm text-gray-600 ml-6">
                        ä»å·²æœ‰ç”³è¯·è¡¨å¤åˆ¶è€—æä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–™æåç§°ã€å•ä»·ã€ä½¿ç”¨æ¬¡æ•°ç­‰åŸºç¡€ä¿¡æ¯
                      </p>
                    </div>
                  </div>

                  {enableCopyFromTemplate && (
                    <Select
                      isRequired
                      description="ç³»ç»Ÿä¼šå¤åˆ¶æ‰€é€‰ç”³è¯·è¡¨ä¸­çš„æ‰€æœ‰è€—æé¡¹ç›®ï¼Œä½†ä¸ä¼šå¤åˆ¶åº“å­˜æ•°é‡ç­‰å˜åŠ¨æ•°æ®"
                      label="é€‰æ‹©æºç”³è¯·è¡¨"
                      placeholder="è¯·é€‰æ‹©è¦å¤åˆ¶è€—æä¿¡æ¯çš„ç”³è¯·è¡¨"
                      selectedKeys={
                        sourceFormId ? [sourceFormId.toString()] : []
                      }
                      onSelectionChange={(keys) => {
                        const key = Array.from(keys)[0] as string;

                        setSourceFormId(key ? parseInt(key) : null);
                      }}
                    >
                      {forms
                        .filter(
                          (form) =>
                            form.status === "active" || form.status === "draft",
                        )
                        .map((form) => (
                          <SelectItem
                            key={form.id.toString()}
                            textValue={`${form.name} (${form.period})`}
                          >
                            <div className="flex flex-col">
                              <span className="font-medium">{form.name}</span>
                              <span className="text-sm text-gray-500">
                                {form.period} - {form.department}
                              </span>
                            </div>
                          </SelectItem>
                        ))}
                    </Select>
                  )}

                  {enableCopyFromTemplate && sourceFormId && (
                    <div className="bg-blue-50 p-3 rounded-lg">
                      <h5 className="text-sm font-medium text-blue-800 mb-2">
                        å°†ä¼šå¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š
                      </h5>
                      <ul className="text-sm text-blue-700 space-y-1">
                        <li>âœ… è€—æåç§°å’Œåˆ†ç±»</li>
                        <li>âœ… å•ä»·ä¿¡æ¯</li>
                        <li>âœ… é‡‡è´­å‘˜ä¿¡æ¯</li>
                        <li>âœ… ä½¿ç”¨å‚æ•°ï¼ˆæ¯è‡ºæ©Ÿç”¨é‡ã€ä½¿ç”¨æ¬¡æ•°ã€ä½¿ç”¨ç«™åˆ«ï¼‰</li>
                        <li>âœ… MOQç­‰é‡‡è´­ä¿¡æ¯</li>
                        <li>âŒ ä¸ä¼šå¤åˆ¶åº“å­˜æ•°é‡ï¼ˆéœ€è¦é‡æ–°å¡«å†™å½“å‰åº“å­˜ï¼‰</li>
                      </ul>
                    </div>
                  )}
                </div>
              )}
            </div>
          </ModalBody>
          <ModalFooter>
            <Button
              color="danger"
              variant="light"
              onPress={() => setFormModalVisible(false)}
            >
              å–æ¶ˆ
            </Button>
            <Button color="primary" onPress={handleFormSubmit}>
              {currentForm ? "æ›´æ–°" : "åˆ›å»º"}
            </Button>
          </ModalFooter>
        </ModalContent>
      </Modal>
    </div>
  );
};

export default DynamicApplicationManager;
